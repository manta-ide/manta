#!/usr/bin/env node
/**
 * Script to generate src/data/graphs.ts from dev-project/manta/graphs
 * Run with: node scripts/generate-graphs-data.js
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const GRAPHS_DIR = path.join(__dirname, '../dev-project/manta/graphs');
const OUTPUT_FILE = path.join(__dirname, '../src/data/graphs.ts');

// Read all graph directories
const graphDirs = fs.readdirSync(GRAPHS_DIR).filter(file => {
  const fullPath = path.join(GRAPHS_DIR, file);
  return fs.statSync(fullPath).isDirectory();
});

console.log(`Found ${graphDirs.length} graphs:`, graphDirs.join(', '));

// Build the graphs data object
const graphsData = {};

for (const graphId of graphDirs) {
  const currentPath = path.join(GRAPHS_DIR, graphId, 'current-graph.xml');
  const basePath = path.join(GRAPHS_DIR, graphId, 'base-graph.xml');

  const currentXml = fs.existsSync(currentPath)
    ? fs.readFileSync(currentPath, 'utf8')
    : '<?xml version="1.0" encoding="UTF-8"?>\n<graph xmlns="urn:app:graph" version="1.0" directed="true">\n  <nodes>\n  </nodes>\n  <edges>\n  </edges>\n</graph>';

  const baseXml = fs.existsSync(basePath)
    ? fs.readFileSync(basePath, 'utf8')
    : '<?xml version="1.0" encoding="UTF-8"?>\n<graph xmlns="urn:app:graph" version="1.0" directed="true">\n  <nodes>\n  </nodes>\n  <edges>\n  </edges>\n</graph>';

  graphsData[graphId] = {
    current: currentXml,
    base: baseXml
  };

  console.log(`✓ Loaded graph: ${graphId}`);
}

// Generate TypeScript file
const tsContent = `// In-memory graph data for deployment on serverless platforms like Vercel
// This file contains all graph data that would normally be stored in the filesystem
// Auto-generated by scripts/generate-graphs-data.js

export const GRAPHS_DATA: Record<string, { current: string; base: string }> = ${JSON.stringify(graphsData, null, 2)};

// Helper function to get available graph IDs
export function getAvailableGraphIds(): string[] {
  return Object.keys(GRAPHS_DATA);
}

// Helper function to check if a graph exists
export function graphExists(graphId: string): boolean {
  return graphId in GRAPHS_DATA;
}
`;

// Write to file
fs.writeFileSync(OUTPUT_FILE, tsContent, 'utf8');

console.log(`\n✅ Successfully generated ${OUTPUT_FILE}`);
console.log(`   Total graphs: ${graphDirs.length}`);
console.log(`   File size: ${(fs.statSync(OUTPUT_FILE).size / 1024).toFixed(2)} KB`);
